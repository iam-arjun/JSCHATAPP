<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat app </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
        integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"
        integrity="sha512-JSCFHhKDilTRRXe9ak/FJ28dcpOJxzQaCd3Xg8MyF6XFjODhy/YMCM8HW0TFDckNHWUewW+kfvhin43hKtJxAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <!-- NAVBAR STARTS...................... -->


    <!-- 
    <nav class="navbar navbar-dark bg-dark ">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent"
            aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse " id="navbarToggleExternalContent ">
            <div class="bg-dark p-4">
                <ul class="navbar-nav mr-auto ">
                    <li class="nav-item">
                        <a class="nav-link" href="#signuppage">Signup</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#loginpage">Login </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#chatpage">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fa-solid fa-circle"
                                id="activeStatus"></i>&nbsp;Account</a>
                    </li>
                    <li class="nav-item" id="logout">
                        <a class="nav-link" href="#"><i class="fa-solid fa-right-from-bracket"></i></a>
                    </li>



                </ul>

            </div>
        </div>
    </nav> -->
    <div class="pos-f-t">

        <nav class="navbar navbar-expand-md navbar-light bg-light">
            <a class="navbar-brand " href="/">JSchat</a>
            <button class="navbar-toggler d-md-none" id="navbarToggler" type="button" data-toggle="collapse"
                data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse d-md-flex justify-content-between w-100" id="navbarToggleExternalContent">
                <ul class="navbar-nav ">
                    <li class="nav-item">
                        <a class="nav-link" href="#signuppage">Signup</a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="#loginpage">Login </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#chatpage">Chat</a>
                    </li>



                </ul>
                <div>
                    <ul class="navbar-nav mr-3">

                        <li class="nav-item">
                            <div class="dropdown show">
                                <a class="btn btn-outline-secondary  dropdown-toggle" href="#" role="button"
                                    id="account-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Account

                                </a>


                                <div class="dropdown-menu" id="account-dropdown-menu">


                                    <div>
                                        <form id="Imgform"
                                            class="d-flex flex-column justify-content-center align-items-center">


                                            <label class="form-label m-1" for="profile-pic"> <img id="selectedAvatar"
                                                    src="https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg"
                                                    class="rounded-circle"
                                                    style="width: 100px; height: 100px; object-fit: cover;"
                                                    alt="pp" /></label>
                                            <input type="file" class="form-control d-none" id="profile-pic"
                                                name="profile-pic" onchange="displayPP()" />
                                            <button data-mdb-ripple-init class="btn btn-outline-warning btn-rounded ">

                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </form>
                                    </div>

                                    <a class="dropdown-item" href="#" id="USERNAME"></a>


                                </div>
                            </div>

                        </li>
                        <li class="nav-item" id="logout">
                            <a class="nav-link" href="#"><i class="fa-solid fa-right-from-bracket"></i></a>
                        </li>

                    </ul>
                </div>

            </div>

        </nav>
    </div>

    <!-- SIGNUP STARTS -->

    <section class="vh-100 py-4 " style="background-color: #f0f1f1;" id="signuppage">
        <div class=" d-flex align-items-center ">
            <div class="container  py-4">
                <div class="row d-flex justify-content-center align-items-center ">
                    <div class="col-12 col-md-9 col-lg-7 col-xl-6">
                        <div class="card" style="border-radius: 15px;">
                            <div class="card-body p-5">
                                <h4 class="text-uppercase text-center mb-5">Create an account</h4>

                                <form id="signupform">

                                    <div class="form-outline mb-2">
                                        <input type="text" id="fullname" class="form-control form-control-lg"
                                            placeholder="FULLNAME" name="fullname" required />

                                    </div>

                                    <div class="form-outline mb-2">
                                        <input type="email" id="email" class="form-control form-control-lg "
                                            placeholder="EMAIL" name="email" required />

                                    </div>

                                    <div class="form-outline mb-2">
                                        <input type="password" id="password" class="form-control form-control-lg"
                                            placeholder="PASSWORD" name="password" minlength="6" required>

                                    </div>

                                    <div class="form-outline mb-2">
                                        <input type="password" id="cpassword" class="form-control form-control-lg"
                                            placeholder="REPEAT PASSWORD" name="cpassword" minlength="6" required />

                                    </div>



                                    <div class="d-flex justify-content-center">
                                        <button type="submit"
                                            class="btn btn-success btn-block  text-light">Register</button>
                                    </div>

                                    <p class="text-center text-muted mt-2 mb-0">Have already an account? <a
                                            href="#loginpage" class="fw-bold text-body"><u>Login here</u></a></p>

                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- LOGIN STARTS -->
    <section class="vh-100 py-5" style="background-color: #f0f1f1;" id="loginpage">
        <div class="container py-4 ">
            <div class="row d-flex justify-content-center align-items-center ">
                <div class="col-12 col-md-8 col-lg-6 col-xl-5">
                    <div class="card shadow-2-strong" style="border-radius: 1rem;">
                        <div class="card-body p-5 text-center">

                            <h3 class="mb-5 text-uppercase">Sign in</h3>
                            <form id="loginform">
                                <div data-mdb-input-init class="form-outline mb-4">
                                    <input type="email" id="l-email" class="form-control form-control-lg"
                                        placeholder="EMAIL" name="email" required />

                                </div>

                                <div class="form-outline mb-4">
                                    <input type="password" id="l-password" class="form-control form-control-lg"
                                        placeholder="PASSWORD" name="password" required />

                                </div>


                                <div class="form-check d-flex justify-content-start mb-4">
                                    <input class="form-check-input" type="checkbox" value="" id="form1Example3" />&nbsp;
                                    <label class="form-check-label" for="form1Example3"> Remember password </label>
                                </div>

                                <button class="btn btn-success  btn-block" type="submit">Login</button>

                            </form>


                            <hr class="my-4">

                            <button class="btn btn-lg btn-block btn-primary mb-2" style="background-color: #ff9d00;"
                                type="submit"><i class="fab fa-google me-2"></i> Sign in with
                                google</button>

                            <button class="btn btn-lg btn-block btn-primary mb-2" style="background-color: #0051ff;"
                                type="submit"><i class="fab fa-facebook-f me-2"></i>Sign in with
                                facebook</button>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- CHAT BOX STARTS -->

    <section style="background-color: #eee;" id="chatpage" class="py-5">
        <div class="container py-5">

            <div class="row d-flex justify-content-center">
                <div class="col-sm-12 col-md-4  card" style="border-radius: 15px;" id="friendsListContainer">
                    <nav id="sidebarMenu" class="bg-white position-sticky">
                        <h4>Friends</h4>
                        <div>
                            <div class="list-group list-group-flush mx-3 mt-4 " id="friendLink">


                            </div>
                        </div>
                    </nav>

                </div>


                <div class="col-sm-12 col-md-8    mt-4" id="chat-col">

                    <div class="card" id="chatbox" style="border-radius: 15px;overflow-y:scroll;height:70vh">
                        <div class="card-header d-flex justify-content-between align-items-center p-3 bg-success text-white border-bottom-0"
                            style="border-top-left-radius: 15px; border-top-right-radius: 15px;position:sticky;top:0;">
                            <i class="fas fa-angle-left" id="chat-box-back-icon" onclick="chatBoxBackIcon()"></i>

                            <p class="mb-0 fw-bold" id='chat_box_top_username'>JSCHATBOX</p>


                            <i class="fas fa-times"></i>
                        </div>


                        <div class="card-body">

                            <div id="chat_splash_text">
                                <h4>
                                    <center>Start to chat by selecting the friends!</center>
                                </h4>
                            </div>
                            <div id="msg-display-area"></div>

                            <p id="sender-msg" class="text-primary"></p>
                            <p id="receiver-msg" class="text-success"></p>


                            <form id="msgform">
                                <div class="form-outline">
                                    <textarea class="form-control" id="msginput" rows="4" name="msg"></textarea>

                                </div>

                                <button class="btn btn-primary btn-sm my-2">SEND</button>


                            </form>


                        </div>


                    </div>

                </div>

                <div>

                </div>


            </div>

        </div>
    </section>






    <script>

        let serverUrl = "https://jschatapp.onrender.com"

        let friendsList = [];
        let GET_MSGS = [];
        let loginStatus = JSON.parse(sessionStorage.getItem('authdata'))
        console.log(loginStatus)

        window.onload = async function () {


            try {
                let USERNAME_CON = document.getElementById('account-dropdown-menu')
                let accountBtn = document.getElementById('account-btn')

                let msgbox = document.getElementById('msginput')

                if (loginStatus) {
                    accountBtn.classList.add('btn-outline-success')
                    let USERNAME = document.getElementById('USERNAME')
                    USERNAME.innerText = loginStatus.authid
                    getProfile()
                    msgbox.disabled = false


                    const response = await axios.get(`${serverUrl}/auth/displayFrns`);
                    friendsList = response.data.data


                    const dataContainer = document.getElementById('friendLink');

                    let onlineusers = await getOnlineUsers()


                    // Attach listener function on state changes

                    friendsList.forEach(async (item, i) => {
                        const itemElement = document.createElement('a');
                        itemElement.className = 'list-group-item list-group-item-action py-2 ripple ';

                        itemElement.addEventListener('click', function (event) {
                            event.preventDefault(); // Prevent the default anchor behavior
                            selectFrn(item.fullname);

                        });
                        if (Object.keys(onlineusers).includes(item.fullname)) {

                            itemElement.innerHTML = `<img src="https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg" id="friendsImg" class="rounded-circle" style="width: 30px;height:30px;object-fit:cover;"
  alt="Avatar" /> <span>${item.fullname} </span><span class="badge badge-success ">Active</span>  `

                            itemElement.querySelector('#friendsImg').src = `UPLOADS/${item.profilePic.filename}`


                            dataContainer.appendChild(itemElement);


                        }
                        else {

                            itemElement.innerHTML = `<img src="https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg" class="rounded-circle"  id="friendsImg" style="width: 30px;height:30px;object-fit:cover;"
  alt="Avatar" /> <span>${item.fullname} </span>`
                            itemElement.querySelector('#friendsImg').src = `UPLOADS/${item.profilePic.filename}`

                            dataContainer.appendChild(itemElement);
                        }



                    });

                }
                else {
                    msgbox.disabled = true;

                    USERNAME_CON.style.display = 'none'


                }

            } catch (error) {
                throw new Error(error)
            }




        }

        if (loginStatus) {
            const socket = io(`${serverUrl}`,
                {

                    query: {
                        userId: loginStatus.authid
                    },
                }
            );
            socket.on("newMessage", (newMessage) => {


                getMsgs(newMessage.senderid)
                // alert('newmsg')



            });


        }




        // PURE JS STARTS HERE..............................................................................

        // SIGNING UP THE FORM
        document.getElementById('signupform').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission behavior
            // Get the values from the form inputs
            let fullname = document.getElementById('fullname')
            let email = document.getElementById('email')
            let password = document.getElementById('password')
            let cpassword = document.getElementById('cpassword')

            // Create a user object with the form data
            const user = {
                fullname: fullname.value,
                email: email.value,
                password: password.value,
                cpassword: cpassword.value
            };

            try {
                // Send the user data to the server using Axios
                const response = await axios.post(`${serverUrl}/auth/signup`, user);


                alert('Signup successful');
                window.location.assign('/')

            } catch (error) {
                // Handle errors
                console.error('Error during signup:', error);
                alert('Signup failed');
            }
            fullname.value = ""; email.value = ""; password.value = ""; cpassword.value = "";
        });

        // LOGIN FORM 
        document.getElementById('loginform').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission behavior
            // Get the values from the form inputs

            let email = document.getElementById('l-email')
            let password = document.getElementById('l-password')


            // Create a user object with the form data
            const user = {

                email: email.value,
                password: password.value,
            };

            try {
                // Send the user data to the server using Axios
                const response = await axios.post(`${serverUrl}/auth/login`, user);


                alert('Login successful');
                sessionStorage.setItem('authdata', JSON.stringify({ isloggedin: true, authid: response.data.data.fullname }))
                window.location.reload()
                window.location.assign('/')


            } catch (error) {
                // Handle errors
                console.error('Error during Login:', error);
                alert('Login failed');


            }
            email.value = ""; password.value = "";

        });

        //LOGOUT 
        document.getElementById('logout').addEventListener('click', async function () {

            try {
                // Send the user data to the server using Axios
                if (confirm('Do you want to logout? ')) {
                    const response = await axios.delete(`${serverUrl}/auth/logout/${loginStatus.authid}`);

                    sessionStorage.removeItem('authdata')
                    alert('Logout successful');
                    window.location.reload()
                }


            } catch (error) {
                // Handle errors
                console.error('Error during Logout:', error);
                alert('Logout failed');
            }
        })

        // MESSGING FORM

        document.getElementById('msgform').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission behavior
            // Get the values from the form inputs

            let newmsg = document.getElementById('msginput')



            // Create a user object with the form data
            const msg = {
                senderid: loginStatus.authid,
                receiverid: document.getElementById("chat_box_top_username").innerHTML,
                msg: newmsg.value

            };

            try {
                // Send the user data to the server using Axios
                const response = await axios.post(`${serverUrl}/msg/sendmsg`, msg);

                getMsgs(msg.receiverid)

                newmsg.value = "";



            } catch (error) {
                throw new Error(error)

            }


        });




        const selectFrn = (username) => {
            document.getElementById("friendsListContainer").style.display = 'none'
            document.getElementById('chat-col').style.display = 'block';

            let chat_splasher_text = document.getElementById("chat_splash_text")
            chat_splasher_text.style.display = 'none'


            document.getElementById("chat_box_top_username").innerHTML = username;



            getMsgs(username)


        }

        const getMsgs = async (username) => {
            try {

                const response = await axios.get(`${serverUrl}/msg/getmsgs`);

                GET_MSGS = response.data.data;

                let msg_area = document.getElementById('msg-display-area')
                msg_area.innerHTML = " "

                GET_MSGS.forEach((item) => {
                    if (item.receiverid === username) {
                        let msg_area = document.getElementById('msg-display-area')
                        let msg_container = document.createElement("div")
                        msg_container.innerHTML = `<div class="d-flex justify-content-end mb-4">
                                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                                    alt="avatar 1" style="width: 45px; height: 100%;">
                                <div class="p-3 ms-3"
                                    style="border-radius: 15px; background-color: rgba(57, 192, 237,.2);">
                                    <p class="small mb-0" id="sender-msg">${item.msg}</p>
                                </div>
                            </div>`
                        msg_area.appendChild(msg_container)

                    }
                    if (item.senderid === username) {
                        let msg_area = document.getElementById('msg-display-area')
                        let msg_container = document.createElement("div")
                        msg_container.innerHTML = `<div class="d-flex justify-content-start mb-4">
                                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                                    alt="avatar 1" style="width: 45px; height: 100%;">
                                <div class="p-3 ms-3"
                                    style="border-radius: 15px; background-color: white;">
                                    <p class="small mb-0" id="sender-msg">${item.msg}</p>
                                </div>
                            </div>`
                        msg_area.appendChild(msg_container)

                    }

                })



            } catch (error) {
                throw new Error(error)
            }

        }


        const getOnlineUsers = async () => {
            try {
                const res = await axios.get(`${serverUrl}/auth/onlineUsers`)
                let tempData = res.data.data
                return tempData



            } catch (error) {
                throw new Error(error)
            }

        }

        const chatBoxBackIcon = () => {
            document.getElementById("friendsListContainer").classList.add('d-md-block')
            document.getElementById('chat-col').classList.add('d-md-block')
        }


        const displayPP = () => {
            const profilePic = document.getElementById('profile-pic').files[0];
            const imgSrc = document.getElementById('selectedAvatar')

            // If there's no file, do nothing
            if (!profilePic) return;

            // Create a new FileReader() object
            let reader = new FileReader();

            // Setup the callback event to run when the file is read
            reader.onload = function logFile(event) {

                imgSrc.src = event.target.result;

            };

            // Read the file
            reader.readAsDataURL(profilePic);
            uploadProfile()
        }

        const uploadProfile = () => {
            document.getElementById('Imgform').addEventListener('submit', async function (event) {
                event.preventDefault();
                const imgSrc = document.getElementById('selectedAvatar')

                const name = loginStatus.authid
                const profilePic = document.getElementById('profile-pic').files[0];



                // If there's no file, do nothing
                if (!profilePic) return;

                // Create a new FileReader() object
                let reader = new FileReader();

                // Setup the callback event to run when the file is read
                reader.onload = function logFile(event) {


                    imgSrc.src = event.target.result;

                };

                // Read the file
                reader.readAsDataURL(profilePic);

                if (!name || !profilePic) {
                    messageElement.textContent = 'Please fill in all fields.';
                    messageElement.classList.add('error');
                    return;
                }



                const formData = new FormData();
                formData.append('name', name);
                formData.append('profile-pic', profilePic);

                try {
                    // Send the form data using Axios
                    const response = await axios.post(`${serverUrl}/auth/uploadimg`, formData)


                    const result = response.data

                    if (result.success) {
                        alert('Profile picture uploaded successfully!')


                        getProfile()


                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    alert(error.message)

                }
            });

        }


        const getProfile = async () => {
            const imgSrc = document.getElementById('selectedAvatar')

            try {

                const res = await axios.get(`${serverUrl}/auth/getProfile`)


                if (res.data.imgUrl) {
                    imgSrc.src = res.data.imgUrl
                    return;

                }



            } catch (error) {
                throw new Error(error);

            }

        }


    </script>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

</body>

</html>